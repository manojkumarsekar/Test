--Delete the broker code inserted as part of prerequisite
DELETE FROM FT_T_FIID
WHERE INST_MNEM IN (SELECT INST_MNEM FROM FT_T_FINS WHERE INST_NME ='${TAIWAN_BROKER}' AND END_TMS IS NULL)
AND FINS_ID_CTXT_TYP='BRSTRDCNTCDE'
AND START_TMS=SYSDATE;

DELETE FROM FT_T_FIID
WHERE INST_MNEM IN (SELECT INST_MNEM FROM FT_T_FINS WHERE INST_NME ='${TAIWAN_BROKER}' AND END_TMS IS NULL)
AND FINS_ID_CTXT_TYP='BRSCNTCDE'
AND START_TMS=SYSDATE;

--End date the new CCRF record created via the feature file
UPDATE FT_T_CCRF SET END_TMS=SYSDATE
WHERE CROSS_REF_PURP_TYP ='BROKER'
AND ACCT_ID IN (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = '${ID}')
AND INSTR_ID IN (SELECT INSTR_ID FROM FT_T_ISID WHERE ISS_ID ='${ISIN_VAR}')
AND FINR_INST_MNEM IN (SELECT INST_MNEM FROM FT_T_FIID WHERE FINS_ID = 'T_FIL-TW' AND FINS_ID_CTXT_TYP = 'BRSTRDCNTCDE')
AND TRUNC(START_TMS) = TRUNC(SYSDATE);

--Revert the updates done to CCRF table as part of pre requisite
UPDATE FT_T_CCRF SET END_TMS=null
WHERE CROSS_REF_PURP_TYP ='BROKER'
AND ACCT_ID IN (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = '${ID}')
AND INSTR_ID IN (SELECT INSTR_ID FROM FT_T_ISID WHERE ISS_ID ='${ISIN_VAR}')
AND FINR_INST_MNEM IN (SELECT INST_MNEM FROM FT_T_FIID WHERE FINS_ID = 'T_FIL-TW' AND FINS_ID_CTXT_TYP = 'BRSTRDCNTCDE')
AND TRUNC(START_TMS) != TRUNC(SYSDATE);

--Revert the changes done to the existing security
UPDATE FT_T_ISID SET END_TMS=SYSDATE
WHERE INSTR_ID IN (SELECT INSTR_ID FROM FT_T_ISID WHERE ISS_ID ='${ISIN_VAR}')
AND END_TMS IS NULL
AND TRUNC(LAST_CHG_TMS)=TRUNC(SYSDATE);

--Revert the changes done to the existing portfolio
UPDATE FT_T_ACID SET END_TMS=SYSDATE
WHERE ACCT_ID IN (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID ='${ID}')
AND END_TMS IS NULL
AND TRUNC(LAST_CHG_TMS)=TRUNC(SYSDATE);

--Delete Open record from My-workList
DELETE ft_wf_uiwa
WHERE main_entity_nme = '${INSTR_NAME}'
AND trunc(CREATED_TMS) = trunc(SYSDATE)
AND result_cde = 0;

commit;
delete FROM Ft_t_ACCV where data_src_id in ('HSBC','SSB') AND AS_OF_TMS >= to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS') AND ACCT_ID IN (SELECT ACCT_ID FROM FT_t_ACID WHERE ACCT_ALT_ID in ('TD00101','TD00102','TD00103') AND acct_id_ctxt_typ='CRTSID' AND END_TMS IS NULL);

delete fT_T_ISPC where INSTR_ID in(SELECT INSTR_ID FROM FT_T_ISID WHERE ISS_ID = 'JP1300511G61' AND END_TMS IS NULL) AND PRC_SRCE_TYP='ESTWSS';

delete ft_t_prfh WHERE ACCT_ID IN (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00102' and acct_id_ctxt_typ='CRTSID' AND END_TMS IS NULL) and INVS_CLSF_TYP ='SSB NAV' and AS_OF_TMS =to_date('17-APR-2018','DD-MON-YYYY');

delete ft_t_accv WHERE ACCT_ID IN (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00102' and acct_id_ctxt_typ='CRTSID' AND END_TMS IS NULL) and AS_OF_TMS in (to_date('17-APR-2018','DD-MON-YYYY'), (to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS')-1));

delete ft_t_accv WHERE ACCT_ID IN (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00101' and acct_id_ctxt_typ='CRTSID' AND END_TMS IS NULL) and AS_OF_TMS in (to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS'), (to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS')-1) );

delete ft_t_accv WHERE ACCT_ID IN (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00103' and acct_id_ctxt_typ='CRTSID' AND END_TMS IS NULL) and AS_OF_TMS in (to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS'), (to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS')-1) );

INSERT INTO ft_t_aisr (AISR_OID,ORG_ID,BK_ID,ACCT_ID,INSTR_ID,ACCT_ISSU_RL_TYP,START_TMS,END_TMS,LAST_CHG_USR_ID,LAST_CHG_TMS,RL_DESC,PART_CAMT,PART_CURR_CDE,PART_CPCT,DATA_STAT_TYP,DATA_SRC_ID)
SELECT new_oid,'EIS ','EIS ',(select acct_id from ft_t_acid where acct_alt_id ='TD00102' and acct_id_ctxt_typ='CRTSID' and end_tms is null),(SELECT INSTR_ID FROM FT_T_ISID WHERE ISS_ID = 'JP1300511G61' AND END_TMS IS NULL),'AUT',sysdate,null,'user1',sysdate,null,null,null,null,'ACTIVE',null
FROM DUAL WHERE NOT EXISTS (SELECT 1 FROM ft_t_aisr WHERE instr_id=(SELECT INSTR_ID FROM FT_T_ISID WHERE ISS_ID = 'JP1300511G61' AND END_TMS IS NULL) and ACCT_ISSU_RL_TYP='AUT');

INSERT INTO ft_t_aisr (AISR_OID,ORG_ID,BK_ID,ACCT_ID,INSTR_ID,ACCT_ISSU_RL_TYP,START_TMS,END_TMS,LAST_CHG_USR_ID,LAST_CHG_TMS,RL_DESC,PART_CAMT,PART_CURR_CDE,PART_CPCT,DATA_STAT_TYP,DATA_SRC_ID)
SELECT new_oid,'EIS ','EIS ',(select acct_id from ft_t_acid where acct_alt_id ='TD00102' and acct_id_ctxt_typ='CRTSID' and end_tms is null),(SELECT INSTR_ID FROM FT_T_ISID WHERE ISS_ID = 'JP1300511G61' AND END_TMS IS NULL),'SUBP',sysdate,null,'user1',sysdate,null,null,null,null,'ACTIVE',null
FROM DUAL WHERE NOT EXISTS (SELECT 1 FROM ft_t_aisr WHERE instr_id = (SELECT INSTR_ID FROM FT_T_ISID WHERE ISS_ID = 'JP1300511G61' AND END_TMS IS NULL) and ACCT_ISSU_RL_TYP='SUBP');

DELETE FT_T_ISGP WHERE INSTr_ID IN (SELECT INSTR_ID FROM FT_T_ISID WHERE ISS_ID = 'JP1300511G61' AND END_TMS IS NULL) AND PRT_DESC='SSB Nav Pricing Securities of Interest';

Insert into FT_T_ACCV (ORG_ID,BK_ID,ACCT_ID,TBL_TYP,VALU_TYP,VALU_CURR_CDE,AS_OF_TMS,VALU_ADJST_TMS,LAST_CHG_TMS,LAST_CHG_USR_ID,VALU_STAT_TYP,VALU_OPT_ID,OFFICIAL_NAV_IND,COLL_VAL_CAMT,CREDIT_LN_CAMT,VALU_VAL_CAMT,NAV_CRTE,SHR_OUTST_CQTY,DATA_SRC_ID,ORIG_DATA_PROV_ID)
values ('EIS ','EIS ',(select distinct acct_id from ft_t_acid where acct_alt_id  ='TD00101' and end_tms is null),'ACCT','MRKT','TWD',(to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS')-1),(to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS')-1),sysdate,'EITW_HSBC_DMP_NAV_PRICE','Success ','ES00000001',null,null,null,175068961,11.2282,15591947.1,'HSBC',null);
Insert into FT_T_ACCV (ORG_ID,BK_ID,ACCT_ID,TBL_TYP,VALU_TYP,VALU_CURR_CDE,AS_OF_TMS,VALU_ADJST_TMS,LAST_CHG_TMS,LAST_CHG_USR_ID,VALU_STAT_TYP,VALU_OPT_ID,OFFICIAL_NAV_IND,COLL_VAL_CAMT,CREDIT_LN_CAMT,VALU_VAL_CAMT,NAV_CRTE,SHR_OUTST_CQTY,DATA_SRC_ID,ORIG_DATA_PROV_ID)
values ('EIS ','EIS ',(select distinct acct_id from ft_t_acid where acct_alt_id  ='TD00101' and end_tms is null),'ACCT','MRKT','TWD',to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS'),to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS'),sysdate,'EITW_HSBC_DMP_NAV_PRICE','Success ','ES00000001',null,null,null,175068962,11.2282,15591947.1,'HSBC',null);

Insert into FT_T_ACCV (ORG_ID,BK_ID,ACCT_ID,TBL_TYP,VALU_TYP,VALU_CURR_CDE,AS_OF_TMS,VALU_ADJST_TMS,LAST_CHG_TMS,LAST_CHG_USR_ID,VALU_STAT_TYP,VALU_OPT_ID,OFFICIAL_NAV_IND,COLL_VAL_CAMT,CREDIT_LN_CAMT,VALU_VAL_CAMT,NAV_CRTE,SHR_OUTST_CQTY,DATA_SRC_ID,ORIG_DATA_PROV_ID)
values ('EIS ','EIS ',(select distinct acct_id from ft_t_acid where acct_alt_id  ='TD00102' and end_tms is null),'ACCT','MRKT','TWD',(to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS')-1),(to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS')-1),sysdate,'EITW_SSB_DMP_NAV_PRICE','Success ','ES00000001',null,null,null,175068961,11.2282,15591947.1,'SSB',null);

-- Shareclass Data setup
INSERT INTO FT_T_ACCR (ORG_ID, BK_ID, ACCT_ID, REP_ORG_ID, REP_BK_ID, REP_ACCT_ID, RL_TYP, START_TMS, LAST_CHG_TMS, LAST_CHG_USR_ID, DATA_STAT_TYP, ACCR_OID)
SELECT 'EIS','EIS',(SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00103' AND ACCT_ID_CTXT_TYP = 'CRTSID' AND END_TMS IS NULL),'EIS','EIS',
(SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00102' AND ACCT_ID_CTXT_TYP = 'CRTSID' AND END_TMS IS NULL),'SHRCLASS',SYSDATE,SYSDATE,'AUTO',
'ACTIVE',NEW_OID FROM DUAL
WHERE NOT EXISTS (SELECT 1 FROM FT_T_ACCR WHERE ACCT_ID = (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00103' AND ACCT_ID_CTXT_TYP = 'CRTSID'  AND END_TMS IS NULL)
AND RL_TYP = 'SHRCLASS' AND REP_ACCT_ID = (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00102' AND ACCT_ID_CTXT_TYP = 'CRTSID' AND END_TMS IS NULL));

INSERT INTO ft_t_acgp(prnt_acct_grp_oid, acct_org_id, acct_bk_id, acct_id, start_tms, prt_purp_typ, last_chg_tms, last_chg_usr_id, acgp_oid)
SELECT acct_grp_oid, 'EIS', 'EIS', (SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00102' AND ACCT_ID_CTXT_TYP = 'CRTSID' AND END_TMS IS NULL), SYSDATE, 'MEMBER', SYSDATE, 'TOM-5351-testing', NEW_OID FROM ft_t_acgr WHERE acct_grp_id = 'TWNLILP' AND end_tms IS NULL
AND NOT EXISTS (SELECT 1 FROM FT_T_ACGP WHERE prnt_acct_grp_oid = (SELECT ACCT_GRP_OID FROM FT_T_ACGR WHERE ACCT_GRP_ID = 'TWNLILP') AND acct_id=(SELECT ACCT_ID FROM FT_T_ACID WHERE ACCT_ALT_ID = 'TD00102' AND ACCT_ID_CTXT_TYP = 'CRTSID' AND END_TMS IS NULL) AND acct_org_id = 'EIS' AND acct_bk_id='EIS' );

Insert into FT_T_ACCV (ORG_ID,BK_ID,ACCT_ID,TBL_TYP,VALU_TYP,VALU_CURR_CDE,AS_OF_TMS,VALU_ADJST_TMS,LAST_CHG_TMS,LAST_CHG_USR_ID,VALU_STAT_TYP,VALU_OPT_ID,OFFICIAL_NAV_IND,COLL_VAL_CAMT,CREDIT_LN_CAMT,VALU_VAL_CAMT,NAV_CRTE,SHR_OUTST_CQTY,DATA_SRC_ID,ORIG_DATA_PROV_ID)
values ('EIS ','EIS ',(select distinct acct_id from ft_t_acid where acct_alt_id  ='TD00103' and end_tms is null),'ACCT','MRKT','TWD',to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS'),to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS'),sysdate,'EITW_SSB_DMP_NAV_PRICE','Success ','ES00000001',null,null,null,175068972,11.2282,15591947.1,'SSB',null);

Insert into FT_T_ACCV (ORG_ID,BK_ID,ACCT_ID,TBL_TYP,VALU_TYP,VALU_CURR_CDE,AS_OF_TMS,VALU_ADJST_TMS,LAST_CHG_TMS,LAST_CHG_USR_ID,VALU_STAT_TYP,VALU_OPT_ID,OFFICIAL_NAV_IND,COLL_VAL_CAMT,CREDIT_LN_CAMT,VALU_VAL_CAMT,NAV_CRTE,SHR_OUTST_CQTY,DATA_SRC_ID,ORIG_DATA_PROV_ID)
values ('EIS ','EIS ',(select distinct acct_id from ft_t_acid where acct_alt_id  ='TD00103' and end_tms is null),'ACCT','MRKT','TWD',(to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS')-1),(to_date('${MAXASOFTMS}','yyyy-mm-dd HH24:MI:SS')-1),sysdate,'EITW_SSB_DMP_NAV_PRICE','Success ','ES00000001',null,null,null,175068971,11.2282,15591947.1,'SSB',null);

commit
--Insert new record into FINS to create the TMB Institution
INSERT INTO FT_T_FINS
(INST_MNEM,START_TMS,LAST_CHG_TMS,LAST_CHG_USR_ID,INST_NME,INST_DESC,PREF_FINS_ID_CTXT_TYP,PREF_FINS_ID,DATA_STAT_TYP)
SELECT NEW_OID,SYSDATE,SYSDATE,'TEST','TMB','TMB','INHOUSE','TMB','ACTIVE'
FROM DUAL WHERE NOT EXISTS (SELECT INST_MNEM FROM FT_T_FINS WHERE PREF_FINS_ID = 'TMB' AND END_TMS IS NULL);

--Insert new record into FINR for KBANK with FINSRL_TYP 'FUNDADM'
INSERT INTO FT_T_FINR
(INST_MNEM,FINSRL_TYP,LAST_CHG_TMS,LAST_CHG_USR_ID,CROSS_REF_ID,START_TMS,DATA_STAT_TYP)
SELECT
(SELECT INST_MNEM FROM FT_T_FINS WHERE PREF_FINS_ID='TMB'),'FUNDADM', SYSDATE,'TESTUSER','TEST1234',SYSDATE,'ACTIVE'
FROM DUAL WHERE NOT EXISTS
(SELECT INST_MNEM FROM FT_T_FINR WHERE INST_MNEM IN (SELECT INST_MNEM FROM FT_T_FINS WHERE PREF_FINS_ID='TMB')
 AND FINSRL_TYP='FUNDADM' AND END_TMS IS NULL);

 --Insert new record into FIID for the created institution
INSERT INTO FT_T_FIID
(FIID_OID,INST_MNEM,FINS_ID_CTXT_TYP,FINS_ID,START_TMS,LAST_CHG_TMS,LAST_CHG_USR_ID,DATA_STAT_TYP,GLOBAL_UNIQ_IND)
SELECT NEW_OID,(SELECT INST_MNEM FROM FT_T_FINS WHERE PREF_FINS_ID='TMB'),'INHOUSE','TMB', SYSDATE,SYSDATE,'TESTUSER','ACTIVE','N'
FROM DUAL WHERE NOT EXISTS
(SELECT INST_MNEM FROM FT_T_FIID WHERE INST_MNEM IN (SELECT INST_MNEM FROM FT_T_FINS WHERE PREF_FINS_ID='TMB')
 AND FINS_ID_CTXT_TYP='INHOUSE'AND FINS_ID='TMB' AND END_TMS IS NULL);

commit;